name: CD - Build and Deploy to GCP

on:
  push:
    branches: [release]
    paths:
      - 'api-project/**'
      - 'ui-project/**'
      - 'docker-compose.yml'
  workflow_dispatch:

env:
  # --- GCP config (dummy values, replace with your real ones or secrets) ---
  GCP_PROJECT_ID: 'dummy-gcp-project-id'
  GCP_REGION: 'europe-west4'
  GAR_LOCATION: 'europe-west4'                          # Artifact Registry location
  ARTIFACT_REGISTRY_REPO: 'dummy-artifact-repo'         # Artifact Registry repository name
  CLOUD_RUN_SERVICE_API: 'dummy-api-service'            # Cloud Run service name for FastAPI
  GCS_BUCKET_UI: 'dummy-ui-bucket'                      # GCS bucket for React SPA
  CLOUD_CDN_URL_MAP: 'dummy-url-map-name'               # (optional) URL map name for CDN invalidation

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write   # required for google-github-actions/auth

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Authenticate to GCP (using service account key stored in GitHub Secrets)
      #    Need a GitHub secret called GCP_SA_KEY with the JSON key for a deploy SA.
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 3. Install gcloud CLI
      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      # 4. Configure Docker to push to Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      # 5. Build & push API Docker image to Artifact Registry
      - name: Build and push API image
        id: build-api
        uses: docker/build-push-action@v5
        with:
          context: ./api-project
          file: ./api-project/Dockerfile
          push: true
          tags: |
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/api-project:${{ github.sha }}
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/api-project:latest

      # 6. Deploy API to Cloud Run (FastAPI backend)
      - name: Deploy API to Cloud Run
        run: |
          IMAGE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/api-project:${{ github.sha }}"
          gcloud run deploy "${{ env.CLOUD_RUN_SERVICE_API }}" \
            --image "$IMAGE" \
            --region "${{ env.GCP_REGION }}" \
            --platform managed \
            --ingress internal-and-cloud-load-balancing \
            --allow-unauthenticated=false \
            --quiet

      # 7. Install Node.js for UI build
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 8. Install dependencies & build React UI
      - name: Install UI dependencies
        working-directory: ./ui-project
        run: npm ci

      - name: Build UI
        working-directory: ./ui-project
        run: npm run build

      # 9. Sync built UI to GCS bucket (Cloud Storage + Cloud CDN)
      #    Ensure the bucket is fronted by HTTPS LB + Cloud CDN per architecture.
      - name: Upload UI build to GCS
        run: |
          gsutil -m rsync -r ./ui-project/build gs://${{ env.GCS_BUCKET_UI }}

      # 10. (Optional) Invalidate Cloud CDN cache so new UI is served immediately
      #     Requires that HTTPS LB / URL map is already configured.
      - name: Invalidate Cloud CDN cache
        if: ${{ always() }}     # run but ignore failures if URL map not found
        run: |
          gcloud compute url-maps invalidate-cdn-cache "${{ env.CLOUD_CDN_URL_MAP }}" \
            --path "/*" \
            --quiet || echo "CDN invalidation skipped (check URL map name or permissions)"
